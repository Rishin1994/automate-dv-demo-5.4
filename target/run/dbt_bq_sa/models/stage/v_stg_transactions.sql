

  create or replace view `trim-field-467501-p5`.`dbt_dataset`.`v_stg_transactions`
  OPTIONS()
  as 







-- Generated by AutomateDV (formerly known as dbtvault)

    

WITH source_data AS (

    SELECT

    ORDER_ID,
    CUSTOMER_ID,
    ORDER_DATE,
    TRANSACTION_DATE,
    TRANSACTION_NUMBER,
    AMOUNT,
    TYPE

    FROM `trim-field-467501-p5`.`dbt_dataset`.`raw_transactions`
),

derived_columns AS (

    SELECT

    ORDER_ID,
    CUSTOMER_ID,
    ORDER_DATE,
    TRANSACTION_DATE,
    TRANSACTION_NUMBER,
    AMOUNT,
    TYPE,
    'RAW_TRANSACTIONS' AS RECORD_SOURCE,
    DATE_ADD(TRANSACTION_DATE, INTERVAL 1 DAY) AS LOAD_DATE,
    TRANSACTION_DATE AS EFFECTIVE_FROM

    FROM source_data
),

hashed_columns AS (

    SELECT

    ORDER_ID,
    CUSTOMER_ID,
    ORDER_DATE,
    TRANSACTION_DATE,
    TRANSACTION_NUMBER,
    AMOUNT,
    TYPE,
    RECORD_SOURCE,
    LOAD_DATE,
    EFFECTIVE_FROM,

    CAST(UPPER(TO_HEX(MD5(NULLIF(CONCAT(
        IFNULL(NULLIF(UPPER(TRIM(CAST(CUSTOMER_ID AS STRING))), ''), '^^'), '||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(TRANSACTION_NUMBER AS STRING))), ''), '^^')
    ), '^^||^^')))) AS STRING) AS TRANSACTION_PK,

    CAST(UPPER(TO_HEX(MD5(NULLIF(UPPER(TRIM(CAST(CUSTOMER_ID AS STRING))), '')))) AS STRING) AS CUSTOMER_PK,

    CAST(UPPER(TO_HEX(MD5(NULLIF(UPPER(TRIM(CAST(ORDER_ID AS STRING))), '')))) AS STRING) AS ORDER_PK

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    ORDER_ID,
    CUSTOMER_ID,
    ORDER_DATE,
    TRANSACTION_DATE,
    TRANSACTION_NUMBER,
    AMOUNT,
    TYPE,
    RECORD_SOURCE,
    LOAD_DATE,
    EFFECTIVE_FROM,
    TRANSACTION_PK,
    CUSTOMER_PK,
    ORDER_PK

    FROM hashed_columns
)

SELECT * FROM columns_to_select;

